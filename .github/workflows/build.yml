on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
    - run: |
        rustup toolchain install nightly
        rustup default nightly
        mv .cargo/actions_config.toml .cargo/config.toml

    - run: bash build/macos/dmg.sh
    - uses: actions/upload-artifact@v4
      with:
        name: macos
        path: stencil2.dmg

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - run: |
        rustup toolchain install nightly
        rustup default nightly
        mv .cargo/actions_config.toml .cargo/config.toml

    - run: bash build/linux/deb.sh
    - uses: actions/upload-artifact@v4
      with:
        name: ubuntu
        path: target/release/bundle/deb/stencil2*.deb

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - run: |
        rustup toolchain install nightly
        rustup default nightly
        mv .cargo/actions_config.toml .cargo/config.toml

    - run: ./build/windows/build.ps1
    - uses: actions/upload-artifact@v4
      with:
        name: windows
        path: target/wix/stencil2-*-x86_64.msi

  version-changelog:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
    - uses: actions/checkout@v4
    - id: version
      run: echo "v$(cargo pkgid | cut -d '#' -f 2)" >> "$GITHUB_OUTPUT"
    - id: changelog
      run: |
        {
        echo 'changelog<<__EOF__'
        hatch run python -c "
        print(open('changelog.md').read().split('# ${{ steps.version.outputs.version }}')[1].split('\n')[1].split('\n##')[0])
        "
        echo __EOF__
        } >> "$GITHUB_OUTPUT"

  github-release:
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-macos
      - build-windows
      - version-changelog

    steps:
    - uses: actions/download-artifact@v4
      with:
        name: macos
        path: dist
    - uses: actions/download-artifact@v4
      with:
        name: linux
        path: dist
    - uses: actions/download-artifact@v4
      with:
        name: windows
        path: dist
    - uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.version-changelog.outputs.version }}
        body: ${{ needs.version-changelog.outputs.changelog }}
        files: dist/*
